<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inspe√ß√£o OAE - Sistema Offline</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#3498db"/>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="Inspe√ß√£o OAE">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height: 100vh; padding: 10px; }
    .container { max-width: 450px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; }
    .header { background: linear-gradient(135deg,#2c3e50 0%,#3498db 100%); color: white; padding: 20px; text-align: center; position: relative; }
    .header h1 { font-size: 1.8em; margin-bottom: 5px; position: relative; z-index: 1; }
    .header p { opacity: 0.9; position: relative; z-index: 1; }
    #openAiBtn { position:absolute; right:12px; top:12px; background:#e8f4f8; color:#0d6efd; border:none; border-radius:20px; padding:6px 12px; cursor:pointer; font-weight:600; }

    .main-content { padding: 20px; max-height: 80vh; overflow-y: auto; }
    .section { margin-bottom: 25px; padding: 20px; border-radius: 15px; background:#f8f9fa; border-left: 4px solid #3498db; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .section-header h3 { margin-bottom: 0; color:#2c3e50; font-size: 1.1em; display: flex; align-items: center; gap: 10px; }

    .form-group { margin-bottom: 15px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    label { display:block; margin-bottom: 5px; font-weight: 600; color:#495057; font-size: 14px; }
    input, select, textarea { width:100%; padding:10px; border:2px solid #e9ecef; border-radius:8px; font-size:14px; transition: border-color .3s ease; }
    input:focus, select:focus, textarea:focus { outline: none; border-color:#3498db; box-shadow:0 0 0 3px rgba(52,152,219,.1); }
    select { background: white; cursor: pointer; }

    .btn, .btn-primary, .btn-secondary, .btn-warning, .btn-filter, .btn-location { border-radius:50px; font-weight:600; cursor:pointer; transition: all .3s ease; border:none; padding:12px 25px; font-size:14px; text-align:center; }
    .btn-primary { background: linear-gradient(135deg,#27ae60,#2ecc71); color:white; width:100%; margin-top:20px; text-transform: uppercase; letter-spacing:.5px; font-size:16px; padding:15px 30px; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow:0 10px 20px rgba(39,174,96,.3); }
    .btn-secondary { background: linear-gradient(135deg,#e74c3c,#c0392b); color:white; margin-top:10px; }
    .btn-secondary:hover { transform: translateY(-2px); box-shadow:0 8px 16px rgba(231,76,60,.3); }
    .btn-warning { background: linear-gradient(135deg,#f39c12,#e67e22); color:white; margin-top:10px; }
    .btn-warning:hover { transform: translateY(-2px); box-shadow:0 8px 16px rgba(243,156,18,.3); }
    .btn-link { background:#e8f4f8; color:#3498db; text-decoration:none; }
    .btn-link:hover { background:#d1e9f5; }
    .btn-location { background:#9b59b6; color:white; width:100%; margin-top:-10px; margin-bottom:15px; }
    .btn-location:hover { background:#8e44ad; }

    .copy-coords { display:flex; gap:10px; margin-bottom:15px; }
    .copy-coords input { background:#e9ecef; }
    .copy-coords button { padding:10px 15px; font-size:12px; flex-shrink:0; }

    .filter-buttons { display:flex; flex-wrap:wrap; gap:5px; margin-bottom:15px; }
    .btn-filter { padding:5px 10px; font-size:12px; background:#e9ecef; color:#495057; }
    .btn-filter.active { background:#3498db; color:white; }

    .registros-list { max-height: 400px; overflow-y:auto; border:1px solid #e9ecef; border-radius:10px; padding:10px; margin-top:15px; }
    .registro-item { background:white; border:1px solid #e9ecef; border-radius:10px; padding:15px; margin-bottom:10px; box-shadow:0 2px 4px rgba(0,0,0,.05); }
    .registro-item-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .registro-item-header h4 { color:#2c3e50; margin:0; font-size:16px; flex-grow:1; }
    .registro-item-actions button { font-size:10px; padding:4px 8px; margin-left:4px; border-radius:15px; flex-shrink:0; }
    .registro-item p { color:#6c757d; font-size:13px; margin-bottom:4px; }

    .tabs { display:flex; background:#f8f9fa; border-radius:10px; margin-bottom:20px; overflow:hidden; }
    .tab { flex:1; padding:15px; background:transparent; border:none; cursor:pointer; font-weight:600; transition: all .3s ease; color:#6c757d; }
    .tab.active { background:#3498db; color:white; }
    .tab:disabled { background-color:#e9ecef; color:#adb5bd; cursor:not-allowed; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }

    .icon { font-size:1.2em; }
    .photo-info { background:#e8f4f8; padding:15px; border-radius:10px; border:1px solid #3498db; margin-top:15px; }
    .photo-info p { color:#6c757d; font-size:14px; text-align:center; font-weight:500; }

    .hidden { display:none; }

    .modal { display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,.5); }
    .modal-content { background:#fefefe; margin:10% auto; padding:20px; border:1px solid #888; width:90%; max-width:700px; border-radius:10px; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px; }
    .modal-header h2 { color:#2c3e50; }
    .close-button { color:#aaa; font-size:28px; font-weight:bold; cursor:pointer; }
    .close-button:hover { color:black; }

    .legenda-table { display:grid; grid-template-columns: 1fr 1fr; gap:20px; font-size:14px; }
    .legenda-table table { width:100%; border-collapse:collapse; }
    .legenda-table th, .legenda-table td { border:1px solid #ddd; padding:8px; text-align:left; }
    .legenda-table th { background:#f2f2f2; font-weight:600; }

    .footer { text-align:center; padding:15px; background:#f8f9fa; border-top:1px solid #eee; }
    .footer p { color:#888; font-size:12px; }

    /* Modal IA */
    #aiModal .modal-content { max-width: 900px; }
    #aiToolbar { display:flex; flex-wrap:wrap; gap:8px; margin:8px 0 6px; }
    .chip { border:1px solid #e5e7eb; background:#f9fafb; padding:6px 10px; border-radius:999px; cursor:pointer; font-size:13px; }
    .chip:hover { background:#eef2ff; }
    #aiPrompt { width:100%; border:1px solid #e5e7eb; border-radius:10px; padding:10px; }
    #aiOutput { border:1px solid #e5e7eb; border-radius:10px; padding:12px; margin-top:10px; min-height:120px; white-space:pre-wrap; font-family: ui-monospace, Menlo, Consolas, monospace; }
    .row-actions { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .btn-ghost { background:#f3f4f6; border:none; padding:8px 14px; border-radius:999px; cursor:pointer; }
    .btn-primary-mini { background:#2563eb; color:#fff; border:none; padding:8px 14px; border-radius:999px; cursor:pointer; }
    .small { font-size:12px; color:#6b7280; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üîç Inspe√ß√£o OAE</h1>
      <p>Gerenciador Offline de Inspe√ß√µes</p>
      <button id="openAiBtn" type="button">ü§ñ Assistente</button>
      <div id="offlineIndicator" style="display:none; background:rgba(255,255,255,.2); padding:5px 10px; border-radius:15px; margin-top:10px; font-size:12px;">
        üì± Funcionando Offline
      </div>
    </div>

    <div class="main-content">
      <div class="tabs">
        <button class="tab active" data-tab="inspecoes" onclick="showTab('inspecoes', this)">Inspe√ß√µes</button>
        <button class="tab" data-tab="dados_gerais" onclick="showTab('dados_gerais', this)" disabled>Dados Gerais</button>
        <button class="tab" data-tab="registros" onclick="showTab('registros', this)" disabled>Registros</button>
        <button class="tab" data-tab="caracteristicas_gerais" onclick="showTab('caracteristicas_gerais', this)" disabled>Caracter√≠sticas Gerais</button>
      </div>

      <div id="inspecoes" class="tab-content active">
        <div class="section">
          <div class="section-header"><h3><span class="icon">üìÇ</span> Gerenciar Inspe√ß√£o</h3></div>
          <div class="form-group">
            <label for="inspecaoAtiva">Selecionar Inspe√ß√£o:</label>
            <select id="inspecaoAtiva"></select>
          </div>
          <div class="form-row">
            <button type="button" class="btn btn-link" id="novaInspecaoBtn">‚ûï Nova Inspe√ß√£o</button>
            <button type="button" class="btn btn-secondary" id="deletarInspecaoBtn">üóëÔ∏è Deletar Inspe√ß√£o Ativa</button>
          </div>
        </div>

        <div class="section">
          <div class="section-header"><h3><span class="icon">üìä</span> Importar/Exportar Dados</h3></div>
          <div class="form-row">
            <button type="button" class="btn btn-link" id="downloadTemplateBtn">üì• Baixar Planilha Modelo</button>
            <button type="button" class="btn btn-link" id="importDataBtn">üì§ Importar Planilha</button>
          </div>
          <div id="importStatus" class="form-group" style="display:none;">
            <p id="importMessage" style="color:#28a745; font-weight:600; text-align:center; padding:10px; background:#d4edda; border-radius:8px;"></p>
          </div>
        </div>

        <div class="section">
          <div class="section-header"><h3><span class="icon">üìã</span> Lista de Inspe√ß√µes</h3></div>
          <div id="inspecoesList" class="registros-list" style="max-height:300px;">
            <p style="text-align:center; color:#6c757d; padding:20px;">Nenhuma inspe√ß√£o criada ainda.</p>
          </div>
        </div>

        <div class="section">
          <div class="section-header"><h3><span class="icon">üóëÔ∏è</span> Limpar Todas as Inspe√ß√µes</h3></div>
          <div class="form-row">
            <button type="button" class="btn btn-secondary" id="deletarTudoBtn">üóëÔ∏è Deletar Todas as Inspe√ß√µes</button>
          </div>
        </div>
      </div>

      <div id="dados_gerais" class="tab-content">
        <div class="section">
          <div class="section-header"><h3><span class="icon">üèóÔ∏è</span> Dados Gerais</h3></div>
          <div class="form-group"><label for="concessionaria">Nome da Concession√°ria:</label><input type="text" id="concessionaria" required></div>
          <div class="form-row">
            <div class="form-group"><label for="rodovia">Rodovia:</label><input type="text" id="rodovia" required></div>
            <div class="form-group"><label for="km">km+m:</label><input type="text" id="km" required></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label for="latitude">Latitude:</label><input type="number" id="latitude" step="any" placeholder="-22.9068"></div>
            <div class="form-group"><label for="longitude">Longitude:</label><input type="number" id="longitude" step="any" placeholder="-43.1729"></div>
          </div>
          <button type="button" class="btn btn-location" id="getCoordsBtn">üìç Obter Coordenadas Atuais</button>
          <div id="copyCoordsContainer" class="copy-coords hidden">
            <input type="text" id="coordsForCopy" readonly>
            <button type="button" id="copyCoordsBtn" class="btn btn-link">Copiar</button>
          </div>
          <div class="form-group"><label for="nome_obra">Nome da Obra:</label><input type="text" id="nome_obra" required></div>
          <div class="form-row">
            <div class="form-group">
              <label for="sentido">Sentido Crescente:</label>
              <select id="sentido" required>
                <option value="">Selecione...</option>
                <option value="Leste">Leste</option><option value="Oeste">Oeste</option>
                <option value="Norte">Norte</option><option value="Sul">Sul</option>
              </select>
            </div>
            <div class="form-group"><label for="data">Data da Inspe√ß√£o:</label><input type="date" id="data" required></div>
          </div>
          <div class="form-group"><label for="inspetor">Inspetor:</label><input type="text" id="inspetor" required></div>
        </div>
      </div>

      <div id="registros" class="tab-content">
        <form id="inspectionForm">
          <div class="section">
            <div class="section-header"><h3><span class="icon">‚ûï</span> Novo Registro</h3></div>

            <div class="section">
              <div class="section-header">
                <h3><span class="icon">üîß</span> Elemento Inspecionado</h3>
                <button type="button" class="btn btn-link" id="abrirModalLegendas">Consultar Legendas</button>
              </div>

              <!-- Select de elementos ser√° preenchido via JS com nomes por extenso -->
              <div class="form-group">
                <label for="elemento">Elemento:</label>
                <select id="elemento" name="elemento" required>
                  <option value="">Carregando...</option>
                </select>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="numero_elemento">N√∫mero do Elemento:</label>
                  <input type="number" id="numero_elemento" name="numero_elemento" min="1" required>
                </div>
                <div class="form-group">
                  <label for="vao">V√£o (Opcional):</label>
                  <select id="vao" name="vao">
                    <option value="">N/A</option>
                    <script>
                      for (let i=1;i<=50;i++){
                        document.write(`<option value="V√£o ${String(i).padStart(2,'0')}">V√£o ${String(i).padStart(2,'0')}</option>`);
                      }
                    </script>
                  </select>
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="face">Face (Opcional):</label>
                  <select id="face" name="face">
                    <option value="">N/A</option>
                    <option value="Norte">Norte</option><option value="Sul">Sul</option>
                    <option value="Leste">Leste</option><option value="Oeste">Oeste</option>
                    <option value="Inferior">Inferior</option><option value="Superior">Superior</option>
                    <option value="Sob a Obra">Sob a Obra</option><option value="Sobre a Obra">Sobre a Obra</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="vista">Vista (Opcional):</label>
                  <select id="vista" name="vista">
                    <option value="">N/A</option>
                    <option value="Norte - Sul">Norte - Sul</option><option value="Sul - Norte">Sul - Norte</option>
                    <option value="Leste - Oeste">Leste - Oeste</option><option value="Oeste - Leste">Oeste - Leste</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="section">
              <div class="section-header"><h3><span class="icon">‚ö†Ô∏è</span> Anomalias</h3></div>

              <div class="filter-buttons" id="anomalia-filters">
                <button type="button" class="btn-filter active" data-category="todos">Todos</button>
                <button type="button" class="btn-filter" data-category="concreto">Concreto</button>
                <button type="button" class="btn-filter" data-category="metalica">Met√°licas</button>
                <button type="button" class="btn-filter" data-category="pavimentacao">Pavim.</button>
                <button type="button" class="btn-filter" data-category="apoios">Apoios</button>
              </div>

              <div class="form-group">
                <label for="anomalia">Anomalia (Opcional):</label>
                <select id="anomalia" name="anomalia">
                  <option value="">Selecione...</option>
                  <optgroup label="1. CONCRETO">
                    <option data-category="concreto" value="1.1">1.1 - Manchas de umidade</option>
                    <option data-category="concreto" value="1.2">1.2 - Manchas de umidade ativa</option>
                    <option data-category="concreto" value="1.3">1.3 - Efloresc√™ncia</option>
                    <option data-category="concreto" value="1.4">1.4 - Estalactites</option>
                    <option data-category="concreto" value="1.5">1.5 - Concreto disgregado</option>
                    <option data-category="concreto" value="1.5-1.17">1.5-1.17 - Concreto disgregado com Armadura Exposta</option>
                    <option data-category="concreto" value="1.6">1.6 - Concreto segregado</option>
                    <option data-category="concreto" value="1.6-1.17">1.6-1.17 - Concreto segregado com Armadura Exposta</option>
                    <option data-category="concreto" value="1.7">1.7 - Concreto desagregado</option>
                    <option data-category="concreto" value="1.7-1.17">1.7-1.17 - Concreto desagregado com Armadura Exposta</option>
                    <option data-category="concreto" value="1.8">1.8 - Redu√ß√£o de cobrimento</option>
                    <option data-category="concreto" value="1.9">1.9 - Fissuras horizontais</option>
                    <option data-category="concreto" value="1.10">1.10 - Fissuras verticais</option>
                    <option data-category="concreto" value="1.11">1.11 - Fissuras diagonais</option>
                    <option data-category="concreto" value="1.12">1.12 - Fissuras mapeadas</option>
                    <option data-category="concreto" value="1.13">1.13 - Trincas (&gt;0,5 mm)</option>
                    <option data-category="concreto" value="1.14">1.14 - Reparos locais inadequados</option>
                    <option data-category="concreto" value="1.15">1.15 - Fora de prumo</option>
                    <option data-category="concreto" value="1.16">1.16 - Desplacamento</option>
                    <option data-category="concreto" value="1.16-1.17">1.16-1.17 - Desplacamento com Armadura Exposta</option>
                    <option data-category="concreto" value="1.17">1.17 - Armadura exposta</option>
                    <option data-category="concreto" value="1.18">1.18 - Manchas enegrecidas</option>
                    <option data-category="concreto" value="1.19">1.19 - Incid√™ncia de vegeta√ß√£o</option>
                    <option data-category="concreto" value="1.20">1.20 - Deslocamento linear ou angular</option>
                    <option data-category="concreto" value="1.21">1.21 - Resto de forma</option>
                    <option data-category="concreto" value="1.22">1.22 - Drenos de inje√ß√£o n√£o arrematados</option>
                    <option data-category="concreto" value="1.23">1.23 - Falha no acabamento dos nichos de ancoragens das armaduras protendidas</option>
                  </optgroup>
                  <optgroup label="2. ESTRUTURAS MET√ÅLICAS">
                    <option data-category="metalica" value="2.1">2.1 - Falha de acabamento na soldagem</option>
                    <option data-category="metalica" value="2.2">2.2 - Corros√£o</option>
                    <option data-category="metalica" value="2.3">2.3 - Empeno/Deforma√ß√£o</option>
                    <option data-category="metalica" value="2.4">2.4 - Falta de parafusos, porcas e arruelas</option>
                    <option data-category="metalica" value="2.5">2.5 - Falha de pintura</option>
                    <option data-category="metalica" value="2.6">2.6 - Trinca transpassante</option>
                    <option data-category="metalica" value="2.7">2.7 - Infiltra√ß√£o no parafuso</option>
                    <option data-category="metalica" value="2.8">2.8 - Oxida√ß√£o</option>
                    <option data-category="metalica" value="2.9">2.9 - Buzinotes curtos, danificados ou ausentes</option>
                    <option data-category="metalica" value="2.10">2.10 - Calcina√ß√£o</option>
                  </optgroup>
                  <optgroup label="3. PAVIMENTA√á√ÉO E SISTEMA VI√ÅRIO">
                    <option data-category="pavimentacao" value="3.1">3.1 - Fuga de material, exist√™ncia de eros√£o e ind√≠cios de instabilidade do talude</option>
                    <option data-category="pavimentacao" value="3.2">3.2 - Desgaste superficial, espessura excessiva, ondula√ß√µes e cavidades no pavimento</option>
                    <option data-category="pavimentacao" value="3.3">3.3 - Defici√™ncia e/ou aus√™ncia de sinaliza√ß√£o horizontal, vertical e a√©rea</option>
                    <option data-category="pavimentacao" value="3.4">3.4 - Descontinuidade do greide</option>
                    <option data-category="pavimentacao" value="3.5">3.5 - Defici√™ncia no sistema de drenagem</option>
                    <option data-category="pavimentacao" value="3.6">3.6 - Aus√™ncia de perfil de veda√ß√£o na junta de dilata√ß√£o</option>
                    <option data-category="pavimentacao" value="3.7">3.7 - Falta de estanqueidade na junta de dilata√ß√£o</option>
                    <option data-category="pavimentacao" value="3.8">3.8 - Sali√™ncia ou depress√£o causando desconforto ao usu√°rio ou impacto na obra</option>
                    <option data-category="pavimentacao" value="3.9">3.9 - Deteriora√ß√£o dos l√°bios polim√©ricos</option>
                    <option data-category="pavimentacao" value="3.10">3.10 - Deteriora√ß√£o dos ber√ßos na junta de dilata√ß√£o</option>
                    <option data-category="pavimentacao" value="3.11">3.11 - Ac√∫mulo de detritos na junta de dilata√ß√£o</option>
                    <option data-category="pavimentacao" value="3.12">Perfil elastom√©rico com descolamento, rasgos ressecamento ou deslocamento</option>
                    <option data-category="pavimentacao" value="3.13">Abertura excessiva da junta de dilata√ß√£o</option>
                    <option data-category="pavimentacao" value="3.14">Trincas</option>
                    <option data-category="pavimentacao" value="3.15">Fissuras</option>
                    <option data-category="pavimentacao" value="3.16">Panela</option>
                    <option data-category="pavimentacao" value="3.17">Exsuda√ß√£o</option>
                    <option data-category="pavimentacao" value="3.18">Defeitos nos trilhos (ondula√ß√µes e desgastes)</option>
                    <option data-category="pavimentacao" value="3.19">Falha de adensamento do lastro</option>
                    <option data-category="pavimentacao" value="3.20">Dormentes soltos, ausentes ou danificados</option>
                    <option data-category="pavimentacao" value="3.21">Fixa√ß√µes danificadas</option>
                    <option data-category="pavimentacao" value="3.22">Trilhos desalinhados em regi√£o de junta</option>
                    <option data-category="pavimentacao" value="3.23">Espessura excessiva do lastro</option>
                    <option data-category="pavimentacao" value="3.24">Trincas tipo "couro de jacar√©"</option>
                    <option data-category="pavimentacao" value="3.25">Dano em pavimento r√≠gido</option>
                  </optgroup>
                  <optgroup label="4. APARELHOS DE APOIO">
                    <option data-category="apoios" value="4.1">4.1 - Aus√™ncia de aparelho de apoio</option>
                    <option data-category="apoios" value="4.2">4.2 - Bloqueio</option>
                    <option data-category="apoios" value="4.3">4.3 - Posicionamento inadequado</option>
                    <option data-category="apoios" value="4.4">4.4 - Ac√∫mulo de detritos, ocorr√™ncia de agentes agressivos</option>
                    <option data-category="apoios" value="4.5">4.5 - Ruptura</option>
                    <option data-category="apoios" value="4.6">4.6 - Fissuras</option>
                    <option data-category="apoios" value="4.7">4.7 - Trincas</option>
                    <option data-category="apoios" value="4.8">4.8 - Esmagamento</option>
                    <option data-category="apoios" value="4.9">4.9 - Deforma√ß√µes laterais excessivas</option>
                    <option data-category="apoios" value="4.10">4.10 - Deslocamentos</option>
                    <option data-category="apoios" value="4.11">4.11 - Distor√ß√£o excessiva</option>
                    <option data-category="apoios" value="4.12">Pe√ßas de a√ßo oxidadas e expostas</option>
                    <option data-category="apoios" value="4.13">Descolamento da fretagem</option>
                    <option data-category="apoios" value="4.14">Assentamento irregular com concentra√ß√£o de esfor√ßos</option>
                    <option data-category="apoios" value="4.15">Deteriora√ß√£o do ber√ßo de assentamento e de nivelamento superior</option>
                  </optgroup>
                </select>
              </div>

              <div class="form-row">
                <div class="form-group"><label for="comprimento">Comprimento (m):</label><input type="number" id="comprimento" name="comprimento" step="0.01" min="0"></div>
                <div class="form-group"><label for="largura">Largura (m):</label><input type="number" id="largura" name="largura" step="0.01" min="0"></div>
              </div>

              <div class="form-group">
                <label for="abertura">Abertura de Fissuras:</label>
                <select id="abertura" name="abertura">
                  <option value="">Selecione...</option>
                  <script>
                    for(let i=10;i<=1000;i+=5){
                      const v=(i/100).toFixed(2).replace('.',',');
                      document.write(`<option value="W${v}">W${v}</option>`);
                    }
                  </script>
                </select>
              </div>
            </div>

            <div class="section">
              <div class="section-header"><h3><span class="icon">üì∏</span> Controle de Fotos</h3></div>
              <div class="form-row">
                <div class="form-group"><label for="tipo_foto">Tipo de Foto:</label>
                  <select id="tipo_foto" name="tipo_foto">
                    <option value="camera">C√¢mera</option>
                    <option value="drone">Drone</option>
                  </select>
                </div>
                <div class="form-group"><label for="qtdFotos">Quantidade:</label><input type="number" id="qtdFotos" name="qtdFotos" value="2" min="1"></div>
              </div>
              <div id="contador_camera_group" class="form-group">
                <label for="fotoInicialCamera">Numera√ß√£o Inicial (C√¢mera):</label><input type="number" id="fotoInicialCamera" min="1">
              </div>
              <div id="contador_drone_group" class="form-group hidden">
                <label for="fotoInicialDrone">Numera√ß√£o Inicial (Drone):</label><input type="number" id="fotoInicialDrone" min="1">
              </div>
              <div class="photo-info"><p id="fotoInfo"></p></div>
              <input type="hidden" id="fotoInicial" name="fotoInicial">
            </div>

            <div class="section">
              <div class="section-header">
                <h3><span class="icon">üìù</span> Observa√ß√µes
                  <button type="button" id="openAiFromObs" class="btn btn-link" style="margin-left:8px;">üß† Preencher com IA</button>
                </h3>
              </div>
              <div class="form-group">
                <label for="observacoes">Observa√ß√µes Adicionais:</label>
                <textarea id="observacoes" name="observacoes" rows="3" placeholder="Descri√ß√£o detalhada..."></textarea>
              </div>
            </div>

            <button type="submit" id="submitBtn" class="btn btn-primary">üíæ Salvar Registro</button>
            <button type="button" id="cancelEditBtn" class="btn btn-warning hidden">Cancelar Edi√ß√£o</button>
          </div>
        </form>

        <hr style="margin-top:30px; border:0; border-top:1px solid #eee;">
        <h3 style="text-align:center; color:#34495e; margin:20px 0;">Registros da Inspe√ß√£o Ativa</h3>
        <div id="registrosList" class="registros-list"></div>
        <button type="button" id="exportButton" class="btn btn-primary" style="background: linear-gradient(135deg,#3498db,#2980b9);">üìÑ Exportar Registros</button>
      </div>

      <div id="caracteristicas_gerais" class="tab-content">
        <div class="section">
          <div class="section-header"><h3><span class="icon">üèóÔ∏è</span> Caracter√≠sticas Gerais da Obra</h3></div>

          <div class="form-row">
            <div class="form-group"><label for="comprimento_total">Comprimento total (m):</label><input type="number" id="comprimento_total" step="0.01" min="0"></div>
            <div class="form-group"><label for="largura_total">Largura total (m):</label><input type="number" id="largura_total" step="0.01" min="0"></div>
          </div>

          <div class="form-row">
            <div class="form-group"><label for="largura_util">Largura √∫til (m):</label><input type="number" id="largura_util" step="0.01" min="0"></div>
            <div class="form-group">
              <label for="sentido_crescente">Sentido crescente da rodovia:</label>
              <select id="sentido_crescente">
                <option value="">Selecione...</option>
                <option value="Norte">Norte</option><option value="Sul">Sul</option>
                <option value="Leste">Leste</option><option value="Oeste">Oeste</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group"><label for="qtd_vaos">Quantidade de v√£os:</label><input type="number" id="qtd_vaos" min="0"></div>
            <div class="form-group"><label for="pilares">Pilares:</label><input type="text" id="pilares"></div>
          </div>

          <div class="form-row">
            <div class="form-group"><label for="juntas_dilatacao">Juntas de dilata√ß√£o:</label><input type="text" id="juntas_dilatacao"></div>
            <div class="form-group"><label for="vaos_tipo">V√£os-tipo (isost√°tico, cont√≠nuo):</label><input type="text" id="vaos_tipo"></div>
          </div>

          <div class="form-group"><label for="tabuleiro_tipo">Tabuleiro-tipo:</label><input type="text" id="tabuleiro_tipo"></div>

          <div class="form-group">
            <label for="tipologia_longitudinal">Tipologia longitudinal (Superestrutura):</label>
            <select id="tipologia_longitudinal">
              <option value="">Selecione...</option>
              <option value="Biapoiado">Biapoiado</option>
              <option value="Isost√°tica">Isost√°tica</option>
              <option value="Cont√≠nua">Cont√≠nua</option>
              <option value="V√£o apoiado em consolo ou dente Gerber">V√£o apoiado em consolo ou dente Gerber</option>
              <option value="Arco superior">Arco superior</option>
              <option value="Arco intermedi√°rio">Arco intermedi√°rio</option>
              <option value="Arco inferior">Arco inferior</option>
              <option value="P√≥rtico">P√≥rtico</option>
              <option value="Estaiada">Estaiada</option>
              <option value="P√™nsil">P√™nsil</option>
              <option value="Treli√ßa">Treli√ßa</option>
              <option value="Outra">Outra</option>
            </select>
          </div>

          <div class="form-group">
            <label for="tipologia_transversal">Tipologia transversal (Superestrutura):</label>
            <select id="tipologia_transversal">
              <option value="">Selecione...</option>
              <option value="Laje">Laje</option>
              <option value="Duas vigas">Duas vigas</option>
              <option value="Grelha">Grelha</option>
              <option value="Se√ß√£o celular">Se√ß√£o celular</option>
              <option value="Treli√ßa">Treli√ßa</option>
              <option value="Outras">Outras</option>
            </select>
          </div>

          <div class="form-group">
            <label for="tipologia_mesoestrutura">Tipologia da mesoestrutura:</label>
            <select id="tipologia_mesoestrutura">
              <option value="">Selecione...</option>
              <option value="Pilares isolados">Pilares isolados</option>
              <option value="Pilares com travessa">Pilares com travessa</option>
              <option value="Pilares contraventados">Pilares contraventados</option>
              <option value="Pilares parede">Pilares parede</option>
              <option value="Pilones">Pilones</option>
              <option value="Outras">Outras</option>
            </select>
          </div>

          <div class="form-group">
            <label for="tipologia_infraestrutura">Tipologia da infraestrutura:</label>
            <select id="tipologia_infraestrutura">
              <option value="">Selecione...</option>
              <option value="Funda√ß√£o superficial">Funda√ß√£o superficial</option>
              <option value="Tubul√µes">Tubul√µes</option>
              <option value="Estaca escavada">Estaca escavada</option>
              <option value="Estaca pr√©-moldada">Estaca pr√©-moldada</option>
              <option value="Estaca met√°lica">Estaca met√°lica</option>
              <option value="Estaca de madeira">Estaca de madeira</option>
              <option value="N√£o identificado">N√£o identificado</option>
              <option value="Outras">Outras</option>
            </select>
          </div>

          <div class="form-group">
            <label for="sistemas_construtivos">Sistemas construtivos:</label>
            <select id="sistemas_construtivos">
              <option value="">Selecione...</option>
              <option value="Moldado no local">Moldado no local</option>
              <option value="Pr√©-moldado somente armado">Pr√©-moldado somente armado</option>
              <option value="Pr√©-moldado protendido (p√≥s-tens√£o)">Pr√©-moldado protendido (p√≥s-tens√£o)</option>
              <option value="Pr√©-moldado protendido (pr√©-tens√£o)">Pr√©-moldado protendido (pr√©-tens√£o)</option>
              <option value="Balan√ßo sucessivo">Balan√ßo sucessivo</option>
              <option value="Aduelas pr√©-moldadas">Aduelas pr√©-moldadas</option>
            </select>
          </div>

          <div class="form-group">
            <label for="natureza_transposicao">Natureza da transposi√ß√£o:</label>
            <select id="natureza_transposicao">
              <option value="">Selecione...</option>
              <option value="Superf√≠cie aqu√≠fera">Superf√≠cie aqu√≠fera</option>
              <option value="Rodovia">Rodovia</option>
              <option value="Ferrovia">Ferrovia</option>
              <option value="Vale">Vale</option>
              <option value="Grota">Grota</option>
              <option value="Contorno de encosta">Contorno de encosta</option>
              <option value="Via urbana">Via urbana</option>
              <option value="Via de pedestre">Via de pedestre</option>
              <option value="Outras">Outras</option>
            </select>
          </div>

          <div class="form-group">
            <label for="materiais">Materiais:</label>
            <select id="materiais">
              <option value="">Selecione...</option>
              <option value="Concreto simples (CS)">Concreto simples (CS)</option>
              <option value="Concreto armado (CA)">Concreto armado (CA)</option>
              <option value="Concreto protendido (CP)">Concreto protendido (CP)</option>
              <option value="A√ßo (A)">A√ßo (A)</option>
              <option value="Madeira (MD)">Madeira (MD)</option>
              <option value="Pedra argamassada (PA)">Pedra argamassada (PA)</option>
              <option value="Mista (MI)">Mista (MI)</option>
              <option value="Alvenaria (AL)">Alvenaria (AL)</option>
              <option value="N√£o identificado">N√£o identificado</option>
              <option value="Outros">Outros</option>
            </select>
          </div>

          <div class="form-row">
            <div class="form-group"><label for="qtd_aparelhos_apoio">Quantidade de aparelhos de apoio:</label><input type="number" id="qtd_aparelhos_apoio" min="0"></div>
            <div class="form-group"><label for="gabarito_vertical_sob">Gabarito vertical sob a OAE (m):</label><input type="number" id="gabarito_vertical_sob" step="0.01" min="0"></div>
          </div>

          <div class="form-row">
            <div class="form-group"><label for="gabarito_vertical_sobre">Gabarito vertical sobre a OAE (m):</label><input type="number" id="gabarito_vertical_sobre" step="0.01" min="0"></div>
            <div class="form-group"><label for="gabarito_navegavel_altura">Gabarito naveg√°vel ‚Äî Altura (m):</label><input type="number" id="gabarito_navegavel_altura" step="0.01" min="0"></div>
            <div class="form-group"><label for="gabarito_navegavel_largura">Gabarito naveg√°vel ‚Äî Largura (m):</label><input type="number" id="gabarito_navegavel_largura" step="0.01" min="0"></div>
          </div>

          <button type="button" id="salvarCaracteristicasBtn" class="btn btn-primary" style="margin-top:10px;">üíæ Salvar Caracter√≠sticas</button>
        </div>
      </div>
    </div>

    <footer class="footer"><p>Desenvolvido por: Jo√£o R√¥mulo Gomes</p></footer>
  </div>

  <!-- Modal de Legendas -->
  <div id="legendaModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Legendas dos Elementos</h2>
        <span class="close-button">&times;</span>
      </div>
      <div class="legenda-table">
        <table>
          <tr><th>Sigla</th><th>Descri√ß√£o</th></tr>
          <tr><td>AA</td><td>Aparelho de apoio</td></tr>
          <tr><td>AB</td><td>Ab√≥bada</td></tr>
          <tr><td>AC</td><td>Acesso</td></tr>
          <tr><td>AD</td><td>Aduela</td></tr>
          <tr><td>AL</td><td>Muro de ala</td></tr>
          <tr><td>ALE</td><td>Alma externa (caix√£o)</td></tr>
          <tr><td>ALI</td><td>Alma interna (caix√£o)</td></tr>
          <tr><td>AP</td><td>Apoio</td></tr>
          <tr><td>B√á</td><td>Ber√ßo</td></tr>
          <tr><td>BL</td><td>Balan√ßo longitudinal</td></tr>
          <tr><td>BLC</td><td>Bloco de funda√ß√£o</td></tr>
          <tr><td>BR</td><td>Barreira r√≠gida</td></tr>
          <tr><td>BU</td><td>Bueiro</td></tr>
          <tr><td>BUZ</td><td>Buzinote</td></tr>
          <tr><td>BZ</td><td>Banzo</td></tr>
          <tr><td>CEL</td><td>C√©lula</td></tr>
          <tr><td>CO</td><td>Cortina</td></tr>
          <tr><td>DG</td><td>Dente gerber</td></tr>
          <tr><td>DI</td><td>Diagonal</td></tr>
          <tr><td>DM</td><td>Defensa met√°lica</td></tr>
          <tr><td>DR</td><td>Drenagem</td></tr>
          <tr><td>EB</td><td>Emboque</td></tr>
          <tr><td>ENC</td><td>Encontro</td></tr>
          <tr><td>ET</td><td>Estaca</td></tr>
          <tr><td>GC</td><td>Guarda-corpos</td></tr>
          <tr><td>GR</td><td>Guarda-rodas</td></tr>
          <tr><td>JD</td><td>Junta de dilata√ß√£o</td></tr>
          <tr><td>LB</td><td>Laje em balan√ßo (transversal)</td></tr>
        </table>
        <table>
          <tr><th>Sigla</th><th>Descri√ß√£o</th></tr>
          <tr><td>LI</td><td>Laje inferior</td></tr>
          <tr><td>LS</td><td>Laje superior</td></tr>
          <tr><td>LT</td><td>Laje de transi√ß√£o</td></tr>
          <tr><td>MF</td><td>Meio-fio</td></tr>
          <tr><td>MT</td><td>Montante</td></tr>
          <tr><td>P</td><td>Pilar</td></tr>
          <tr><td>PA</td><td>Parede</td></tr>
          <tr><td>PC</td><td>Piso de concreto</td></tr>
          <tr><td>PF</td><td>Pavimento flex√≠vel</td></tr>
          <tr><td>PIL</td><td>Pilone</td></tr>
          <tr><td>PR</td><td>Pavimento r√≠gido</td></tr>
          <tr><td>PS</td><td>Passeio</td></tr>
          <tr><td>SAP</td><td>Sapata</td></tr>
          <tr><td>SH</td><td>Sinaliza√ß√£o Horizontal</td></tr>
          <tr><td>SJ</td><td>Sarjeta</td></tr>
          <tr><td>SV</td><td>Sinaliza√ß√£o Vertical</td></tr>
          <tr><td>TA</td><td>Talude</td></tr>
          <tr><td>TRE</td><td>Treli√ßa</td></tr>
          <tr><td>TUB</td><td>Tubul√£o</td></tr>
          <tr><td>V</td><td>V√£o</td></tr>
          <tr><td>VA</td><td>Valeta</td></tr>
          <tr><td>VL</td><td>Viga longarina</td></tr>
          <tr><td>VLR</td><td>Viga longarina de rampa</td></tr>
          <tr><td>VLT</td><td>Viga longarina de travessia</td></tr>
          <tr><td>VT</td><td>Viga transversina</td></tr>
          <tr><td>VTR</td><td>Viga travessa</td></tr>
          <tr><td>VTRAV</td><td>Viga de travamento</td></tr>
        </table>
      </div>
    </div>
  </div>

  <!-- Inputs ocultos para importa√ß√£o -->
  <input type="file" id="fileInput" accept=".xlsx,.xls" style="display:none;">

  <!-- =================== L√ìGICA =================== -->
  <script>
    // ====== 1) MAPA DE ELEMENTOS (sigla <-> nome) ======
    const ELEMENTOS_MAP = [
      // Com sigla oficial:
      {sigla:'AA', nome:'Aparelho de apoio'},
      {sigla:'AB', nome:'Ab√≥bada'},
      {sigla:'AC', nome:'Acesso'},
      {sigla:'AD', nome:'Aduela'},
      {sigla:'AL', nome:'Muro de ala'},
      {sigla:'ALE', nome:'Alma externa (caix√£o)'},
      {sigla:'ALI', nome:'Alma interna (caix√£o)'},
      {sigla:'AP', nome:'Apoio'},
      {sigla:'B√á', nome:'Ber√ßo'},
      {sigla:'BL', nome:'Balan√ßo longitudinal'},
      {sigla:'BLC', nome:'Bloco de funda√ß√£o'},
      {sigla:'BR', nome:'Barreira r√≠gida'},
      {sigla:'BU', nome:'Bueiro'},
      {sigla:'BUZ', nome:'Buzinote'},
      {sigla:'BZ', nome:'Banzo'},
      {sigla:'CEL', nome:'C√©lula'},
      {sigla:'CO', nome:'Cortina'},
      {sigla:'DG', nome:'Dente gerber'},
      {sigla:'DI', nome:'Diagonal'},
      {sigla:'DM', nome:'Defensa met√°lica'},
      {sigla:'DR', nome:'Drenagem'},
      {sigla:'EB', nome:'Emboque'},
      {sigla:'ENC', nome:'Encontro'},
      {sigla:'ET', nome:'Estaca'},
      {sigla:'GC', nome:'Guarda-corpos'},
      {sigla:'GR', nome:'Guarda-rodas'},
      {sigla:'JD', nome:'Junta de dilata√ß√£o'},
      {sigla:'LB', nome:'Laje em balan√ßo (transversal)'},
      {sigla:'LI', nome:'Laje inferior'},
      {sigla:'LS', nome:'Laje superior'},
      {sigla:'LT', nome:'Laje de transi√ß√£o'},
      {sigla:'MF', nome:'Meio-fio'},
      {sigla:'MT', nome:'Montante'},
      {sigla:'P',  nome:'Pilar'},
      {sigla:'PA', nome:'Parede'},
      {sigla:'PC', nome:'Piso de concreto'},
      {sigla:'PF', nome:'Pavimento flex√≠vel'},
      {sigla:'PIL',nome:'Pilone'},
      {sigla:'PR', nome:'Pavimento r√≠gido'},
      {sigla:'PS', nome:'Passeio'},
      {sigla:'SAP',nome:'Sapata'},
      {sigla:'SH', nome:'Sinaliza√ß√£o Horizontal'},
      {sigla:'SJ', nome:'Sarjeta'},
      {sigla:'SV', nome:'Sinaliza√ß√£o Vertical'},
      {sigla:'TA', nome:'Talude'},
      {sigla:'TRE',nome:'Treli√ßa'},
      {sigla:'TUB',nome:'Tubul√£o'},
      {sigla:'V',  nome:'V√£o'},
      {sigla:'VA', nome:'Valeta'},
      {sigla:'VL', nome:'Viga longarina'},
      {sigla:'VLR',nome:'Viga longarina de rampa'},
      {sigla:'VLT',nome:'Viga longarina de travessia'},
      {sigla:'VT', nome:'Viga transversina'},
      {sigla:'VTR',nome:'Viga travessa'},
      {sigla:'VTRAV',nome:'Viga de travamento'},

      // Itens sem sigla oficial (mantidos por extenso):
      {sigla:'', nome:'FOTO CAPA PANOR√ÇMICA'},
      {sigla:'', nome:'BLOCO DE ANCORAGEM'},
      {sigla:'', nome:'CABO DE PROTENS√ÉO'},
      {sigla:'', nome:'JANELA'},
      {sigla:'', nome:'JUNTA JUSANTE'},
      {sigla:'', nome:'PINGADEIRA'},
      {sigla:'', nome:'PISTA'},
      {sigla:'', nome:'PLACA DE FECHAMENTO'},
      {sigla:'', nome:'RAMPA'},
      {sigla:'SV-BARREIRAS', nome:'Sinaliza√ß√£o Vertical ‚Äî Barreiras'},
      {sigla:'SV-GABARITO',  nome:'Sinaliza√ß√£o Vertical ‚Äî Gabarito'},
      {sigla:'', nome:'TESTEIRA'},
      {sigla:'', nome:'TRAVESSIA'},
      {sigla:'', nome:'TRECHO'},
      {sigla:'', nome:'TUBO ARMCO'},
      {sigla:'', nome:'TUBULA√á√ÉO DE UTILIDADES'},
      {sigla:'', nome:'FINAL DE INSPE√á√ÉO'},
      // "L" isolado no antigo select: assumiremos "Laje" (sem sigla espec√≠fica)
      {sigla:'', nome:'Laje'}
    ];

    const SIGLA_POR_NOME = {};
    const NOME_POR_SIGLA = {};
    ELEMENTOS_MAP.forEach(e => {
      SIGLA_POR_NOME[e.nome] = e.sigla || '';
      if (e.sigla) NOME_POR_SIGLA[e.sigla] = e.nome;
    });

    // ====== 2) UI/TABS ======
    function showTab(tabName, element) {
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      element.classList.add('active');
    }
  </script>

  <!-- ====== APP ====== -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const appState = { db: {}, activeInspecaoId: null, editingRecordId: null };

      const inspectionForm = document.getElementById('inspectionForm');
      const inspecaoAtivaSelect = document.getElementById('inspecaoAtiva');
      const novaInspecaoBtn = document.getElementById('novaInspecaoBtn');
      const deletarInspecaoBtn = document.getElementById('deletarInspecaoBtn');
      const getCoordsBtn = document.getElementById('getCoordsBtn');
      const copyCoordsContainer = document.getElementById('copyCoordsContainer');
      const coordsForCopyInput = document.getElementById('coordsForCopy');
      const copyCoordsBtn = document.getElementById('copyCoordsBtn');
      const registrosList = document.getElementById('registrosList');
      const exportButton = document.getElementById('exportButton');
      const salvarCaracteristicasBtn = document.getElementById('salvarCaracteristicasBtn');

      const dadosGeraisFields = {
        concessionaria: document.getElementById('concessionaria'),
        rodovia: document.getElementById('rodovia'),
        km: document.getElementById('km'),
        nome_obra: document.getElementById('nome_obra'),
        sentido: document.getElementById('sentido'),
        data: document.getElementById('data'),
        inspetor: document.getElementById('inspetor'),
        latitude: document.getElementById('latitude'),
        longitude: document.getElementById('longitude'),

        comprimento_total: document.getElementById('comprimento_total'),
        largura_total: document.getElementById('largura_total'),
        largura_util: document.getElementById('largura_util'),
        sentido_crescente: document.getElementById('sentido_crescente'),
        qtd_vaos: document.getElementById('qtd_vaos'),
        pilares: document.getElementById('pilares'),
        juntas_dilatacao: document.getElementById('juntas_dilatacao'),
        vaos_tipo: document.getElementById('vaos_tipo'),
        tabuleiro_tipo: document.getElementById('tabuleiro_tipo'),
        tipologia_longitudinal: document.getElementById('tipologia_longitudinal'),
        tipologia_transversal: document.getElementById('tipologia_transversal'),
        tipologia_mesoestrutura: document.getElementById('tipologia_mesoestrutura'),
        tipologia_infraestrutura: document.getElementById('tipologia_infraestrutura'),
        sistemas_construtivos: document.getElementById('sistemas_construtivos'),
        natureza_transposicao: document.getElementById('natureza_transposicao'),
        materiais: document.getElementById('materiais'),
        qtd_aparelhos_apoio: document.getElementById('qtd_aparelhos_apoio'),
        gabarito_vertical_sob: document.getElementById('gabarito_vertical_sob'),
        gabarito_vertical_sobre: document.getElementById('gabarito_vertical_sobre'),
        gabarito_navegavel_altura: document.getElementById('gabarito_navegavel_altura'),
        gabarito_navegavel_largura: document.getElementById('gabarito_navegavel_largura')
      };

      const registroFields = {
        elemento: document.getElementById('elemento'),
        numero_elemento: document.getElementById('numero_elemento'),
        face: document.getElementById('face'),
        vao: document.getElementById('vao'),
        vista: document.getElementById('vista'),
        anomalia: document.getElementById('anomalia'),
        comprimento: document.getElementById('comprimento'),
        largura: document.getElementById('largura'),
        abertura: document.getElementById('abertura'),
        observacoes: document.getElementById('observacoes')
      };

      const tipoFotoSelect = document.getElementById('tipo_foto');
      const qtdFotosInput = document.getElementById('qtdFotos');
      const fotoInicialCameraInput = document.getElementById('fotoInicialCamera');
      const fotoInicialDroneInput = document.getElementById('fotoInicialDrone');
      const fotoInicialHidden = document.getElementById('fotoInicial');
      const fotoInfo = document.getElementById('fotoInfo');

      const modal = document.getElementById('legendaModal');
      const btnAbrirModal = document.getElementById('abrirModalLegendas');
      const spanCloseModal = document.querySelector('.close-button');
      const tabs = document.querySelectorAll('.tab');
      const submitBtn = document.getElementById('submitBtn');
      const cancelEditBtn = document.getElementById('cancelEditBtn');

      const anomaliaSelect = document.getElementById('anomalia');
      const anomaliaOptions = Array.from(anomaliaSelect.options);
      const filterButtons = document.querySelectorAll('#anomalia-filters .btn-filter');

      // ===== 2.1) Preenche o SELECT de elementos com nomes por extenso =====
      function buildElementoOptions() {
        const sel = registroFields.elemento;
        sel.innerHTML = '<option value="">Selecione...</option>';
        const arr = ELEMENTOS_MAP.slice().sort((a,b)=> a.nome.localeCompare(b.nome,'pt'));
        for (const e of arr) {
          const opt = document.createElement('option');
          opt.textContent = e.nome;
          opt.value = e.nome;           // valor por extenso
          opt.dataset.sigla = e.sigla;  // guarda sigla
          sel.appendChild(opt);
        }
      }
      buildElementoOptions();

      // ===== Modal legendas =====
      btnAbrirModal.onclick = () => { modal.style.display = "block"; };
      spanCloseModal.onclick = () => { modal.style.display = "none"; };
      window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; };

      // ===== Filtro de anomalias =====
      function filterAnomalias(category) {
        anomaliaSelect.value = '';
        anomaliaOptions.forEach(option => {
          if (option.value === '') { option.style.display = ''; return; }
          const optionCategory = option.dataset.category;
          option.style.display = (category === 'todos' || category === optionCategory) ? '' : 'none';
        });
        filterButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.category === category));
      }
      filterButtons.forEach(btn => btn.addEventListener('click', () => filterAnomalias(btn.dataset.category)));

      // ===== Local DB =====
      const loadDb = () => { appState.db = JSON.parse(localStorage.getItem('OAE_INSPECTIONS_DB')) || {}; };
      const saveDb = () => { localStorage.setItem('OAE_INSPECTIONS_DB', JSON.stringify(appState.db)); };

      const populateInspecaoSelector = () => {
        inspecaoAtivaSelect.innerHTML = '';
        const ids = Object.keys(appState.db).sort();
        if (ids.length === 0) {
          inspecaoAtivaSelect.innerHTML = '<option value="">Crie uma nova inspe√ß√£o</option>';
          updateInspecoesList();
          return;
        }
        ids.forEach(id => {
          const o = document.createElement('option');
          o.value = id; o.textContent = id;
          inspecaoAtivaSelect.appendChild(o);
        });
        updateInspecoesList();
      };

      const updateInspecoesList = () => {
        const inspecoesList = document.getElementById('inspecoesList');
        const ids = Object.keys(appState.db).sort();
        if (ids.length === 0) {
          inspecoesList.innerHTML = '<p style="text-align:center; color:#6c757d; padding:20px;">Nenhuma inspe√ß√£o criada ainda.</p>';
          return;
        }
        inspecoesList.innerHTML = '';
        ids.forEach(id => {
          const inspecao = appState.db[id];
          const item = document.createElement('div');
          item.className = 'registro-item';
          item.innerHTML = `
            <div class="registro-item-header">
              <h4>${id}</h4>
              <div class="registro-item-actions">
                <button class="btn btn-link" onclick="selectInspecao('${id}')">üìã</button>
                <button class="btn btn-secondary" onclick="deleteInspecao('${id}')">üóëÔ∏è</button>
              </div>
            </div>
            <p><strong>Concession√°ria:</strong> ${inspecao.dadosGerais.concessionaria || 'N√£o informado'}</p>
            <p><strong>Obra:</strong> ${inspecao.dadosGerais.nome_obra || 'N√£o informado'}</p>
            <p><strong>Rodovia:</strong> ${inspecao.dadosGerais.rodovia || 'N√£o informado'}</p>
            <p><strong>KM:</strong> ${inspecao.dadosGerais.km || 'N√£o informado'}</p>
            <p><strong>Registros:</strong> ${inspecao.registros.length} item(s)</p>
          `;
          inspecoesList.appendChild(item);
        });
      };

      const updateTabStates = () => {
        const has = !!appState.activeInspecaoId;
        tabs.forEach(tab => { if (tab.dataset.tab !== 'inspecoes') tab.disabled = !has; });
      };

      const setActiveInspecao = (id) => {
        appState.activeInspecaoId = id;
        updateTabStates();
        if (cancelEditBtn.offsetParent !== null) cancelEditBtn.click();

        if (!id) {
          Object.values(dadosGeraisFields).forEach(f => f.value = '');
          dadosGeraisFields.data.value = new Date().toISOString().split('T')[0];
          loadRegistros([]);
          copyCoordsContainer.classList.add('hidden');
          return;
        }
        const inspecao = appState.db[id];
        if (!inspecao) return;

        for (const key in inspecao.dadosGerais) {
          if (dadosGeraisFields[key]) dadosGeraisFields[key].value = inspecao.dadosGerais[key] || '';
        }

        if (inspecao.dadosGerais.latitude && inspecao.dadosGerais.longitude) {
          coordsForCopyInput.value = `${inspecao.dadosGerais.latitude}, ${inspecao.dadosGerais.longitude}`;
          copyCoordsContainer.classList.remove('hidden');
        } else copyCoordsContainer.classList.add('hidden');

        fotoInicialCameraInput.value = inspecao.contadores.camera;
        fotoInicialDroneInput.value = inspecao.contadores.drone;
        toggleContadorInputs();
        loadRegistros(inspecao.registros);
      };

      const saveActiveInspecaoData = () => {
        if (!appState.activeInspecaoId) return;
        const inspecao = appState.db[appState.activeInspecaoId];
        if (!inspecao) return;
        for (const key in dadosGeraisFields) inspecao.dadosGerais[key] = dadosGeraisFields[key].value;
        saveDb();
      };

      // Helpers para nome/sigla em registros (retrocompatibilidade)
      function resolveElementoNome(r) {
        return r.elemento_nome || r.elemento || (r.elemento_sigla ? (NOME_POR_SIGLA[r.elemento_sigla] || r.elemento_sigla) : '');
      }
      function resolveElementoSigla(r) {
        if (r.elemento_sigla) return r.elemento_sigla;
        if (r.elemento_nome) return SIGLA_POR_NOME[r.elemento_nome] || '';
        if (r.elemento) return SIGLA_POR_NOME[r.elemento] || (NOME_POR_SIGLA[r.elemento] ? r.elemento : '');
        return '';
      }

      const loadRegistros = (registros=[]) => {
        registrosList.innerHTML = '';
        if (registros.length === 0) {
          registrosList.innerHTML = '<p style="text-align:center; color:#6c757d; padding:20px;">Nenhum registro para esta inspe√ß√£o.</p>';
          return;
        }
        registros.slice().reverse().forEach(registro => {
          const fotoFinal = parseInt(registro.fotoInicial) + parseInt(registro.qtdFotos) - 1;
          const nome = resolveElementoNome(registro);
          const sigla = resolveElementoSigla(registro);
          const item = document.createElement('div');
          item.className = 'registro-item';
          item.innerHTML = `
            <div class="registro-item-header">
              <h4>${nome} ${sigla ? `(${sigla})` : ''} ‚Äî ${registro.numero_elemento}</h4>
              <div class="registro-item-actions">
                <button class="btn btn-link" onclick="duplicateRegistro('${registro.id}')">üìÑ</button>
                <button class="btn btn-link" onclick="editRegistro('${registro.id}')">‚úèÔ∏è</button>
                <button class="btn btn-secondary" onclick="deleteRegistro('${registro.id}')">üóëÔ∏è</button>
              </div>
            </div>
            <p><strong>Anomalia:</strong> ${registro.anomalia}</p>
            <p><strong>Fotos (${registro.tipo_foto}):</strong> ${registro.fotoInicial} a ${fotoFinal}</p>
          `;
          registrosList.appendChild(item);
        });
      };

      window.deleteRegistro = (id) => {
        if (!appState.activeInspecaoId || !confirm('Tem certeza?')) return;
        const inspecao = appState.db[appState.activeInspecaoId];
        inspecao.registros = inspecao.registros.filter(r => r.id != id);
        saveDb(); loadRegistros(inspecao.registros);
      };

      window.selectInspecao = (id) => {
        inspecaoAtivaSelect.value = id;
        setActiveInspecao(id);
        showTab('dados_gerais', document.querySelector('.tab[data-tab="dados_gerais"]'));
      };

      window.deleteInspecao = (id) => {
        if (!confirm(`Tem certeza que deseja DELETAR PERMANENTEMENTE a inspe√ß√£o "${id}" e todos os seus registros?`)) return;
        delete appState.db[id]; saveDb(); populateInspecaoSelector();
        const firstId = Object.keys(appState.db)[0] || null;
        setActiveInspecao(firstId); if (firstId) inspecaoAtivaSelect.value = firstId;
      };

      function populateFormWithRecord(id) {
        const inspecao = appState.db[appState.activeInspecaoId];
        const record = inspecao.registros.find(r => r.id === id);
        if (!record) return;

        filterAnomalias('todos');

        // Elemento (seleciona por nome)
        const nome = resolveElementoNome(record);
        registroFields.elemento.value = nome;

        // Campos simples
        ['numero_elemento','face','vao','vista','comprimento','largura','abertura','observacoes'].forEach(k => {
          if (record[k] !== undefined && registroFields[k]) registroFields[k].value = record[k];
        });

        // Anomalia (usa texto como no select)
        const opt = Array.from(anomaliaSelect.options).find(o => o.textContent === record.anomalia);
        anomaliaSelect.value = opt ? opt.value : '';

        // Fotos
        tipoFotoSelect.value = record.tipo_foto;
        qtdFotosInput.value = record.qtdFotos;
        fotoInicialCameraInput.value = record.fotoInicial;
        fotoInicialDroneInput.value = record.fotoInicial;
        toggleContadorInputs();
      }

      window.editRegistro = (id) => {
        appState.editingRecordId = id;
        populateFormWithRecord(id);
        submitBtn.textContent = 'üíæ Atualizar Registro';
        cancelEditBtn.classList.remove('hidden');
        showTab('registros', document.querySelector('.tab[data-tab="registros"]'));
        inspectionForm.scrollIntoView({ behavior:'smooth' });
      };

      window.duplicateRegistro = (id) => {
        appState.editingRecordId = null;
        const inspecao = appState.db[appState.activeInspecaoId];
        const record = inspecao.registros.find(r => r.id === id);
        if (!record) return;
        populateFormWithRecord(id);
        submitBtn.textContent = 'üíæ Salvar Registro';
        cancelEditBtn.classList.add('hidden');
        const tipoFoto = tipoFotoSelect.value;
        if (tipoFoto === 'camera') fotoInicialCameraInput.value = inspecao.contadores.camera;
        else fotoInicialDroneInput.value = inspecao.contadores.drone;
        updatePhotoInfo();
        inspectionForm.scrollIntoView({ behavior:'smooth' });
        alert("Registro duplicado. Altere o necess√°rio e salve como um novo registro.");
      };

      cancelEditBtn.addEventListener('click', () => {
        appState.editingRecordId = null;
        submitBtn.textContent = 'üíæ Salvar Registro';
        cancelEditBtn.classList.add('hidden');
        inspectionForm.reset();
        const inspecao = appState.db[appState.activeInspecaoId];
        if (inspecao) {
          fotoInicialCameraInput.value = inspecao.contadores.camera;
          fotoInicialDroneInput.value = inspecao.contadores.drone;
        }
        toggleContadorInputs();
      });

      inspecaoAtivaSelect.addEventListener('change', () => { saveActiveInspecaoData(); setActiveInspecao(inspecaoAtivaSelect.value); });

      novaInspecaoBtn.addEventListener('click', () => {
        const rodovia = prompt("Digite a Rodovia (ex: BR-101):");
        const km = prompt("Digite o KM (ex: 50+300):");
        if (!rodovia || !km) return alert("Rodovia e KM s√£o obrigat√≥rios.");
        const newId = `${rodovia.trim()}_${km.trim()}`.replace(/ /g,'_');
        if (appState.db[newId]) return alert("Uma inspe√ß√£o com essa Rodovia e KM j√° existe.");
        appState.db[newId] = {
          dadosGerais: {
            rodovia, km, data: new Date().toISOString().split('T')[0],
            inspetor:'', concessionaria:'', nome_obra:'', sentido:'',
            latitude:'', longitude:''
          },
          contadores: { camera:1, drone:1 },
          registros: []
        };
        saveDb(); populateInspecaoSelector();
        inspecaoAtivaSelect.value = newId; setActiveInspecao(newId);
        alert(`Nova inspe√ß√£o "${newId}" criada. V√° para a aba 'Dados Gerais' para preencher o resto das informa√ß√µes.`);
        showTab('dados_gerais', document.querySelector('.tab[data-tab="dados_gerais"]'));
      });

      deletarInspecaoBtn.addEventListener('click', () => {
        if (!appState.activeInspecaoId) return alert("Nenhuma inspe√ß√£o selecionada.");
        if (!confirm(`Tem certeza que deseja DELETAR PERMANENTEMENTE a inspe√ß√£o "${appState.activeInspecaoId}" e todos os seus registros?`)) return;
        delete appState.db[appState.activeInspecaoId];
        saveDb(); populateInspecaoSelector();
        const firstId = Object.keys(appState.db)[0] || null;
        setActiveInspecao(firstId); if (firstId) inspecaoAtivaSelect.value = firstId;
      });

      salvarCaracteristicasBtn.addEventListener('click', () => { saveActiveInspecaoData(); alert('Caracter√≠sticas gerais salvas com sucesso!'); });
      Object.values(dadosGeraisFields).forEach(f => f.addEventListener('blur', saveActiveInspecaoData));

      // Geolocaliza√ß√£o
      getCoordsBtn.addEventListener('click', () => {
        if (!("geolocation" in navigator)) { alert("Geolocaliza√ß√£o n√£o √© suportada pelo seu navegador."); return; }
        navigator.geolocation.getCurrentPosition(
          (pos)=>{
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            dadosGeraisFields.latitude.value = lat.toFixed(7);
            dadosGeraisFields.longitude.value = lon.toFixed(7);
            coordsForCopyInput.value = `${lat.toFixed(7)}, ${lon.toFixed(7)}`;
            copyCoordsContainer.classList.remove('hidden');
            saveActiveInspecaoData();
            alert('Coordenadas obtidas com sucesso!');
          },
          (err)=>{
            let msg = "Ocorreu um erro desconhecido.";
            if (err.code===err.PERMISSION_DENIED) msg = "Permiss√£o para acessar a localiza√ß√£o foi negada.";
            else if (err.code===err.POSITION_UNAVAILABLE) msg = "A informa√ß√£o de localiza√ß√£o n√£o est√° dispon√≠vel.";
            else if (err.code===err.TIMEOUT) msg = "A requisi√ß√£o para obter a localiza√ß√£o expirou.";
            alert(msg);
          }
        );
      });

      copyCoordsBtn.addEventListener('click', () => {
        coordsForCopyInput.select();
        document.execCommand('copy');
        alert('Coordenadas copiadas para a √°rea de transfer√™ncia!');
      });

      // Fotos
      function updatePhotoInfo() {
        const tipo = tipoFotoSelect.value;
        const numInicial = (tipo==='camera') ? parseInt(fotoInicialCameraInput.value) : parseInt(fotoInicialDroneInput.value);
        const qtd = parseInt(qtdFotosInput.value) || 0;
        const numFinal = isNaN(numInicial) || isNaN(qtd) ? '' : numInicial + qtd - 1;
        fotoInicialHidden.value = numInicial;
        fotoInfo.textContent = `Fotos (${tipo}): ${numInicial || '?'} a ${numFinal || '?'}`;
      }
      function toggleContadorInputs() {
        document.getElementById('contador_camera_group').classList.toggle('hidden', tipoFotoSelect.value !== 'camera');
        document.getElementById('contador_drone_group').classList.toggle('hidden', tipoFotoSelect.value !== 'drone');
        updatePhotoInfo();
      }
      tipoFotoSelect.addEventListener('change', toggleContadorInputs);
      [qtdFotosInput, fotoInicialCameraInput, fotoInicialDroneInput].forEach(i => i.addEventListener('input', updatePhotoInfo));
      function updateContadorStorage(tipo, valor) {
        if (!appState.activeInspecaoId) return;
        const inspecao = appState.db[appState.activeInspecaoId];
        if (inspecao && !appState.editingRecordId) { inspecao.contadores[tipo] = parseInt(valor) || 1; saveDb(); }
      }
      fotoInicialCameraInput.addEventListener('change', ()=>updateContadorStorage('camera', fotoInicialCameraInput.value));
      fotoInicialDroneInput.addEventListener('change', ()=>updateContadorStorage('drone',  fotoInicialDroneInput.value));

      // Submit
      inspectionForm.addEventListener('submit', (e)=>{
        e.preventDefault();
        if (!appState.activeInspecaoId) { alert("Nenhuma inspe√ß√£o ativa. Crie ou selecione uma inspe√ß√£o primeiro."); return; }
        saveActiveInspecaoData();
        const inspecao = appState.db[appState.activeInspecaoId];

        const formData = new FormData(inspectionForm);
        let newRecordData = {};
        formData.forEach((v,k)=>{ newRecordData[k]=v; });

        // Nome e sigla do elemento (sempre gravar os dois campos)
        const optSel = registroFields.elemento.options[registroFields.elemento.selectedIndex];
        const elemento_nome  = registroFields.elemento.value || '';
        const elemento_sigla = (optSel && optSel.dataset.sigla) ? optSel.dataset.sigla : (SIGLA_POR_NOME[elemento_nome] || '');

        if (appState.editingRecordId) {
          const idx = inspecao.registros.findIndex(r => r.id === appState.editingRecordId);
          if (idx > -1) {
            const original = inspecao.registros[idx];
            inspecao.registros[idx] = {
              ...original,
              ...newRecordData,
              elemento_nome,
              elemento_sigla
            };
            let anomaliaField = inspecao.registros[idx].anomalia;
            if (!anomaliaField) inspecao.registros[idx].anomalia = "Foto Geral";
            else {
              const ao = document.querySelector(`#anomalia option[value="${anomaliaField}"]`);
              if (ao) inspecao.registros[idx].anomalia = ao.textContent;
            }
          }
          alert('Registro atualizado com sucesso!');
          cancelEditBtn.click();
        } else {
          newRecordData.id = Date.now().toString();
          // normaliza anomalia para o texto exibido
          if (!newRecordData.anomalia) newRecordData.anomalia = "Foto Geral";
          else {
            const ao = document.querySelector(`#anomalia option[value="${newRecordData.anomalia}"]`);
            if (ao) newRecordData.anomalia = ao.textContent;
          }
          // adiciona os campos de elemento
          newRecordData.elemento_nome = elemento_nome;
          newRecordData.elemento_sigla = elemento_sigla;

          inspecao.registros.push(newRecordData);

          // Atualiza contador de fotos
          const tipoFoto = newRecordData.tipo_foto;
          const novoContador = parseInt(newRecordData.fotoInicial) + parseInt(newRecordData.qtdFotos);
          inspecao.contadores[tipoFoto] = novoContador;
          if (tipoFoto === 'camera') fotoInicialCameraInput.value = novoContador;
          else fotoInicialDroneInput.value = novoContador;

          alert('Registro salvo com sucesso!');
        }

        saveDb();

        // Limpa campos de registro (mant√©m select de elementos)
        ['numero_elemento','face','vao','vista','comprimento','largura','abertura','observacoes'].forEach(k=>{
          if (registroFields[k]) registroFields[k].value = '';
        });
        registroFields.elemento.value = ''; // limpa escolha do elemento
        updatePhotoInfo();
        loadRegistros(inspecao.registros);
      });

      // Exporta√ß√£o (3 abas). Registros agora t√™m 2 colunas de elemento
      exportButton.addEventListener('click', ()=>{
        if (!appState.activeInspecaoId) { alert("Nenhuma inspe√ß√£o ativa para exportar."); return; }
        const inspecao = appState.db[appState.activeInspecaoId];
        const registros = inspecao.registros;
        if (registros.length === 0) { alert('Nenhum registro para exportar nesta inspe√ß√£o.'); return; }

        // 1. Dados Gerais
        const dadosGeraisHeaders = ['Concession√°ria','Rodovia','KM','Latitude','Longitude','Nome da Obra','Sentido','Data','Inspetor'];
        const dadosGeraisData = [[
          inspecao.dadosGerais.concessionaria || '',
          inspecao.dadosGerais.rodovia || '',
          inspecao.dadosGerais.km || '',
          inspecao.dadosGerais.latitude || '',
          inspecao.dadosGerais.longitude || '',
          inspecao.dadosGerais.nome_obra || '',
          inspecao.dadosGerais.sentido || '',
          inspecao.dadosGerais.data || '',
          inspecao.dadosGerais.inspetor || ''
        ]];
        const wsDadosGerais = XLSX.utils.aoa_to_sheet([dadosGeraisHeaders, ...dadosGeraisData]);

        // 2. Caracter√≠sticas Gerais
        const caracteristicasHeaders = [
          'Comprimento total (m)','Largura total (m)','Largura √∫til (m)','Sentido crescente',
          'Quantidade de v√£os','Pilares','Juntas de dilata√ß√£o','V√£os-tipo','Tabuleiro-tipo',
          'Tipologia longitudinal (Superestrutura)','Tipologia transversal (Superestrutura)',
          'Tipologia da mesoestrutura','Tipologia da infraestrutura',
          'Sistemas construtivos','Natureza da transposi√ß√£o','Materiais',
          'Quantidade de aparelhos de apoio','Gabarito vertical sob a OAE (m)',
          'Gabarito vertical sobre a OAE (m)','Gabarito naveg√°vel ‚Äî Altura (m)','Gabarito naveg√°vel ‚Äî Largura (m)'
        ];
        const cg = inspecao.dadosGerais;
        const caracteristicasData = [[
          cg.comprimento_total || '', cg.largura_total || '', cg.largura_util || '', cg.sentido_crescente || '',
          cg.qtd_vaos || '', cg.pilares || '', cg.juntas_dilatacao || '', cg.vaos_tipo || '', cg.tabuleiro_tipo || '',
          cg.tipologia_longitudinal || '', cg.tipologia_transversal || '', cg.tipologia_mesoestrutura || '',
          cg.tipologia_infraestrutura || '', cg.sistemas_construtivos || '', cg.natureza_transposicao || '',
          cg.materiais || '', cg.qtd_aparelhos_apoio || '', cg.gabarito_vertical_sob || '',
          cg.gabarito_vertical_sobre || '', cg.gabarito_navegavel_altura || '', cg.gabarito_navegavel_largura || ''
        ]];
        const wsCaracteristicas = XLSX.utils.aoa_to_sheet([caracteristicasHeaders, ...caracteristicasData]);

        // 3. Registros (com Elemento por extenso + Sigla)
        const registrosHeaders = [
          'ID','Elemento (por extenso)','Sigla','N√∫mero do Elemento','Face','V√£o','Vista','Anomalia',
          'Comprimento (m)','Largura (m)','Abertura Fissura','Tipo de Foto',
          'Foto Inicial','Foto Final','Qtd Fotos','Observa√ß√µes'
        ];
        const registrosData = registros.map(r=>{
          const fotoFinal = parseInt(r.fotoInicial) + parseInt(r.qtdFotos) - 1;
          const elNome = resolveElementoNome(r) || '';
          const elSigla = resolveElementoSigla(r) || '';
          return [
            r.id,
            elNome,
            elSigla,
            r.numero_elemento,
            r.face || '',
            r.vao || '',
            r.vista || '',
            r.anomalia || '',
            r.comprimento || '',
            r.largura || '',
            r.abertura || '',
            r.tipo_foto,
            r.fotoInicial,
            fotoFinal,
            r.qtdFotos,
            (r.observacoes || '').replace(/</g,'&lt;').replace(/>/g,'&gt;')
          ];
        });
        const wsRegistros = XLSX.utils.aoa_to_sheet([registrosHeaders, ...registrosData]);

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, wsDadosGerais, "Dados Gerais");
        XLSX.utils.book_append_sheet(wb, wsCaracteristicas, "Caracter√≠sticas Gerais");
        XLSX.utils.book_append_sheet(wb, wsRegistros, "Registros");

        const nomeArquivo = `inspecao_${appState.activeInspecaoId}`.replace(/[^a-zA-Z0-9\-_]/g,'_');
        XLSX.writeFile(wb, `${nomeArquivo}.xlsx`);
      });

      // Import/Template
      const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
      const importDataBtn = document.getElementById('importDataBtn');
      const fileInput = document.getElementById('fileInput');
      const importStatus = document.getElementById('importStatus');
      const importMessage = document.getElementById('importMessage');

      downloadTemplateBtn.addEventListener('click', ()=>{
        const headers = ['Concession√°ria','Nome da Obra','Rodovia','KM+M'];
        const sample = [
          ['Concession√°ria Exemplo','Obra Exemplo','BR-101','50+300'],
          ['','','',''],['','','',''],['','','',''],['','','','']
        ];
        const ws = XLSX.utils.aoa_to_sheet([headers,...sample]);
        ws['!cols'] = [{width:20},{width:25},{width:15},{width:15}];
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Dados Gerais");
        XLSX.writeFile(wb, 'modelo_dados_gerais.xlsx');
      });

      importDataBtn.addEventListener('click', ()=> fileInput.click());

      function showImportMessage(message, type) {
        importMessage.textContent = message;
        importMessage.style.color = type==='success' ? '#28a745' : type==='warning' ? '#ffc107' : '#dc3545';
        importMessage.style.background = type==='success' ? '#d4edda' : type==='warning' ? '#fff3cd' : '#f8d7da';
        importStatus.style.display = 'block';
        setTimeout(()=>{ importStatus.style.display = 'none'; }, 5000);
      }

      fileInput.addEventListener('change', (event)=>{
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e)=>{
          try{
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type:'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header:1 });

            const expectedHeaders = ['Concession√°ria','Nome da Obra','Rodovia','KM+M'];
            const headers = jsonData[0];
            if (!headers || headers.length<4) { showImportMessage('‚ùå Formato inv√°lido. Use a planilha modelo.','error'); return; }
            const isValid = expectedHeaders.every((h,i)=> headers[i] && headers[i].toString().toLowerCase().includes(h.toLowerCase()));
            if (!isValid) { showImportMessage('‚ùå Cabe√ßalhos inv√°lidos. Use a planilha modelo.','error'); return; }

            let imported=0, skipped=0;
            for (let i=1;i<jsonData.length;i++){
              const row = jsonData[i]; if (!row || row.length<4) continue;
              const concessionaria = row[0] || '';
              const nomeObra = row[1] || '';
              const rodovia = row[2] || '';
              const km = row[3] || '';
              if (!rodovia || !km) { skipped++; continue; }
              const newId = `${rodovia.trim()}_${km.trim()}`.replace(/ /g,'_');
              if (appState.db[newId]) { skipped++; continue; }
              appState.db[newId] = {
                dadosGerais: {
                  concessionaria, nome_obra:nomeObra, rodovia, km,
                  data:new Date().toISOString().split('T')[0],
                  inspetor:'', sentido:'', latitude:'', longitude:'',
                  comprimento_total:'', largura_total:'', largura_util:'', sentido_crescente:'',
                  qtd_vaos:'', pilares:'', juntas_dilatacao:'', vaos_tipo:'', tabuleiro_tipo:'',
                  tipologia_longitudinal:'', tipologia_transversal:'', tipologia_mesoestrutura:'',
                  tipologia_infraestrutura:'', sistemas_construtivos:'', natureza_transposicao:'',
                  materiais:'', qtd_aparelhos_apoio:'', gabarito_vertical_sob:'', gabarito_vertical_sobre:'',
                  gabarito_navegavel_altura:'', gabarito_navegavel_largura:''
                },
                contadores:{camera:1, drone:1},
                registros:[]
              };
              imported++;
            }
            saveDb(); populateInspecaoSelector();

            if (imported>0){
              showImportMessage(`‚úÖ ${imported} inspe√ß√£o(√µes) importada(s)!${skipped>0 ? ' '+skipped+' linha(s) ignorada(s).' : ''}`, 'success');
              const ids = Object.keys(appState.db);
              if (ids.length>0){ const firstId = ids[0]; inspecaoAtivaSelect.value = firstId; setActiveInspecao(firstId); showTab('dados_gerais', document.querySelector('.tab[data-tab="dados_gerais"]')); }
            } else showImportMessage('‚ö†Ô∏è Nenhuma inspe√ß√£o importada. Verifique os dados.','warning');

            fileInput.value = '';
          }catch(err){
            console.error(err);
            showImportMessage('‚ùå Erro ao processar o arquivo. Verifique o formato.','error');
          }
        };
        reader.readAsArrayBuffer(file);
      });

      // Init
      const initApp = () => {
        loadDb(); populateInspecaoSelector();
        const firstId = Object.keys(appState.db)[0] || null;
        if (firstId) inspecaoAtivaSelect.value = firstId;
        setActiveInspecao(firstId);
      };
      initApp();

      const deletarTudoBtn = document.getElementById('deletarTudoBtn');
      if (deletarTudoBtn) {
        deletarTudoBtn.addEventListener('click', ()=>{
          if (confirm('Tem certeza que deseja DELETAR TODAS AS INSPE√á√ïES? Esta a√ß√£o √© irrevers√≠vel!')) {
            localStorage.removeItem('OAE_INSPECTIONS_DB');
            location.reload();
          }
        });
      }
    });
  </script>

  <!-- ===== Service Worker e Offline ===== -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('./sw.js')
          .then(function(registration) {
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  if (confirm('Uma nova vers√£o do aplicativo est√° dispon√≠vel. Deseja atualizar agora?')) {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch(function(err) { console.log('Falha ao registrar o Service Worker:', err); });
      });
    }

    function checkOfflineStatus() {
      const offlineIndicator = document.getElementById('offlineIndicator');
      if (!navigator.onLine) { if (offlineIndicator) offlineIndicator.style.display = 'block'; }
      else { if (offlineIndicator) offlineIndicator.style.display = 'none'; }
    }
    window.addEventListener('online',  ()=>{ const i=document.getElementById('offlineIndicator'); if(i) i.style.display='none'; });
    window.addEventListener('offline', ()=>{ const i=document.getElementById('offlineIndicator'); if(i) i.style.display='block'; });
    checkOfflineStatus();
  </script>

  <!-- ===== MODAL DO ASSISTENTE IA ===== -->
  <div id="aiModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="aiTitle">
      <div class="modal-header">
        <h2 id="aiTitle">Assistente de IA ‚Äî Inspe√ß√£o OAE</h2>
        <span class="close-button" id="closeAiModal" title="Fechar">&times;</span>
      </div>

      <div id="aiToolbar">
        <span class="chip" data-template="obs">‚úçÔ∏è Gerar observa√ß√£o</span>
        <span class="chip" data-template="diag">üß™ Diagn√≥stico curto</span>
        <span class="chip" data-template="sug">üß† Plano de a√ß√£o</span>
        <span class="chip" data-template="sum">üìã Resumo t√©cnico</span>
      </div>

      <textarea id="aiPrompt" rows="5" placeholder="Escreva sua pergunta ou use os atalhos acima..."></textarea>
      <div class="row-actions">
        <button id="askAiBtn" class="btn-primary-mini">Perguntar com contexto</button>
        <button id="pasteAiBtn" class="btn-ghost">üìù Inserir em Observa√ß√µes</button>
        <button id="copyAiBtn" class="btn-ghost">üìã Copiar</button>
        <span id="aiOnlineHint" class="small" style="margin-left:auto;"></span>
      </div>

      <div id="aiOutput" aria-live="polite"></div>
      <div class="small">O contexto √© coletado automaticamente de ‚ÄúDados Gerais‚Äù, ‚ÄúCaracter√≠sticas‚Äù e do registro atual. Se estiver offline, a IA fica desativada.</div>
    </div>
  </div>

  <!-- ===== Integra√ß√£o com IA (UI local; sua API pr√≥pria em /api/ia) ===== -->
  <script>
    (function(){
      const aiModal = document.getElementById('aiModal');
      const openAiBtn = document.getElementById('openAiBtn');
      const openAiFromObs = document.getElementById('openAiFromObs');
      const closeAiModal = document.getElementById('closeAiModal');
      const aiPrompt = document.getElementById('aiPrompt');
      const aiOutput = document.getElementById('aiOutput');
      const askAiBtn = document.getElementById('askAiBtn');
      const copyAiBtn = document.getElementById('copyAiBtn');
      const pasteAiBtn = document.getElementById('pasteAiBtn');
      const aiOnlineHint = document.getElementById('aiOnlineHint');

      const openModal=(prefill='')=>{ aiPrompt.value=prefill; aiOutput.textContent=''; aiModal.style.display='block'; aiModal.setAttribute('aria-hidden','false'); updateOnlineHint(); toggleAskDisabled(); };
      const closeModal=()=>{ aiModal.style.display='none'; aiModal.setAttribute('aria-hidden','true'); };
      openAiBtn && openAiBtn.addEventListener('click', ()=>openModal(''));
      openAiFromObs && openAiFromObs.addEventListener('click', ()=>openModal('Gerar uma OBSERVA√á√ÉO t√©cnica (3‚Äì6 linhas) com base nos campos preenchidos.'));
      closeAiModal && closeAiModal.addEventListener('click', closeModal);
      aiModal && aiModal.addEventListener('click', (e)=>{ if(e.target===aiModal) closeModal(); });

      document.querySelectorAll('#aiToolbar .chip').forEach(chip=>{
        chip.addEventListener('click', ()=>{
          const t = chip.getAttribute('data-template');
          let txt='';
          if (t==='obs') txt='Gerar OBSERVA√á√ÉO t√©cnica (3‚Äì6 linhas) considerando: elemento/v√£o/face/vista, anomalia, severidade (se houver), causa prov√°vel e recomenda√ß√£o curta.';
          else if (t==='diag') txt='Produzir DIAGN√ìSTICO curto (4‚Äì8 linhas) descrevendo o quadro e poss√≠veis implica√ß√µes estruturais, de acordo com a anomalia.';
          else if (t==='sug') txt='Sugerir um PLANO DE A√á√ÉO objetivo (monitorar / corrigir / interven√ß√£o) e justificar em 2‚Äì3 pontos.';
          else if (t==='sum') txt='Escrever um RESUMO t√©cnico (at√© 8 linhas) consolidando dados gerais, caracter√≠sticas e registro atual.';
          aiPrompt.value = txt;
        });
      });

      function updateOnlineHint(){ aiOnlineHint.textContent = navigator.onLine ? 'üü¢ Online' : 'üî¥ Offline'; }
      function toggleAskDisabled(){ askAiBtn.disabled = !navigator.onLine; askAiBtn.title = navigator.onLine ? '' : 'Sem conex√£o. A IA exige internet.'; }
      window.addEventListener('online', ()=>{ updateOnlineHint(); toggleAskDisabled(); });
      window.addEventListener('offline',()=>{ updateOnlineHint(); toggleAskDisabled(); });

      function v(id){ const el=document.getElementById(id); return el ? (el.value||'') : ''; }

      function coletarContexto(){
        const dadosGerais = {
          concessionaria:v('concessionaria'), rodovia:v('rodovia'), km:v('km'),
          nome_obra:v('nome_obra'), sentido:v('sentido'), data:v('data'),
          inspetor:v('inspetor'), latitude:v('latitude'), longitude:v('longitude')
        };
        const caracteristicas = {
          comprimento_total:v('comprimento_total'), largura_total:v('largura_total'), largura_util:v('largura_util'),
          sentido_crescente:v('sentido_crescente'), qtd_vaos:v('qtd_vaos'), pilares:v('pilares'),
          juntas_dilatacao:v('juntas_dilatacao'), vaos_tipo:v('vaos_tipo'), tabuleiro_tipo:v('tabuleiro_tipo'),
          tipologia_longitudinal:v('tipologia_longitudinal'), tipologia_transversal:v('tipologia_transversal'),
          tipologia_mesoestrutura:v('tipologia_mesoestrutura'), tipologia_infraestrutura:v('tipologia_infraestrutura'),
          sistemas_construtivos:v('sistemas_construtivos'), natureza_transposicao:v('natureza_transposicao'),
          materiais:v('materiais'), qtd_aparelhos_apoio:v('qtd_aparelhos_apoio'),
          gabarito_vertical_sob:v('gabarito_vertical_sob'), gabarito_vertical_sobre:v('gabarito_vertical_sobre'),
          gabarito_navegavel_altura:v('gabarito_navegavel_altura'), gabarito_navegavel_largura:v('gabarito_navegavel_largura')
        };

        const elemento_nome = v('elemento');
        const elemento_sigla = (function(){
          const sel = document.getElementById('elemento');
          const opt = sel ? sel.options[sel.selectedIndex] : null;
          return opt ? (opt.dataset.sigla || '') : (SIGLA_POR_NOME[elemento_nome] || '');
        })();

        const registroAtual = {
          elemento_nome, elemento_sigla,
          numero_elemento:v('numero_elemento'), vao:v('vao'), face:v('face'), vista:v('vista'),
          anomalia:(function(){ const sel=document.getElementById('anomalia'); const opt=sel?sel.options[sel.selectedIndex]:null; return opt?opt.textContent:''; })(),
          comprimento:v('comprimento'), largura:v('largura'), abertura:v('abertura'),
          tipo_foto:v('tipo_foto'), qtd_fotos:v('qtdFotos'), foto_inicial:v('fotoInicial'),
          observacoes_digitadas:v('observacoes')
        };

        let ultimaInspecao=null;
        try{
          const db = JSON.parse(localStorage.getItem('OAE_INSPECTIONS_DB')||'{}');
          const activeId = (document.getElementById('inspecaoAtiva')||{}).value || null;
          if (activeId && db[activeId]){
            const regs=db[activeId].registros||[];
            ultimaInspecao={ id:activeId, contadores:db[activeId].contadores||{}, total_registros:regs.length, ultimos_registros:regs.slice(-5) };
          }
        }catch(e){}

        return { dadosGerais, caracteristicas, registroAtual, ultimaInspecao };
      }

      askAiBtn.addEventListener('click', async ()=>{
        if (!navigator.onLine) { alert('Voc√™ est√° offline. A IA precisa de internet.'); return; }
        const prompt = (document.getElementById('aiPrompt').value||'').trim();
        if (!prompt) { alert('Escreva sua pergunta ou use um atalho.'); return; }

        aiOutput.textContent = '‚è≥ Processando...';
        const contexto = coletarContexto();

        const systemPrompt = `
Voc√™ √© um assistente t√©cnico de inspe√ß√µes de OAEs no Brasil.
- Estilo: objetivo, t√©cnico e claro; 3‚Äì8 linhas quando n√£o especificado.
- N√£o invente normas/valores; evite marcas.
- Ao gerar "observa√ß√µes", considere: localiza√ß√£o (elemento/v√£o/face/vista), anomalia, severidade quando houver, causa prov√°vel e recomenda√ß√£o curta.
- Se contexto estiver incompleto, diga educadamente o que falta.
`.trim();

        try{
          const res = await fetch('/api/ia', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ system: systemPrompt, prompt, context: contexto })
          });
          if (!res.ok || !res.body) { aiOutput.textContent='‚ùå Erro ao chamar /api/ia'; return; }
          const reader = res.body.getReader(); aiOutput.textContent='';
          const decoder = new TextDecoder();
          while(true){
            const {value, done} = await reader.read();
            if (done) break;
            aiOutput.textContent += decoder.decode(value, {stream:true});
          }
        }catch(err){
          console.error(err);
          aiOutput.textContent = '‚ùå Falha de conex√£o com o servidor de IA.';
        }
      });

      copyAiBtn.addEventListener('click', async ()=>{
        try { await navigator.clipboard.writeText(aiOutput.textContent||''); alert('Resposta copiada!'); }
        catch(e){ alert('N√£o foi poss√≠vel copiar.'); }
      });
      pasteAiBtn.addEventListener('click', ()=>{
        const out = aiOutput.textContent||'';
        const obs = document.getElementById('observacoes');
        if (!obs) { alert('Campo "Observa√ß√µes" n√£o encontrado.'); return; }
        if (!out) { alert('Gere uma resposta da IA primeiro.'); return; }
        obs.value = out; alert('Texto inserido em "Observa√ß√µes".');
        aiModal.style.display='none'; aiModal.setAttribute('aria-hidden','true');
      });
    })();
  </script>
</body>
</html>
